# thirdparty

---

## Log4cxx日志框架

Log4cxx具有的一些显著特性使得C++者可以将其放入自己的工具箱中，这些特性包括灵活的配置能力，多种输出手段，丰富的格式控制，出色的性能。如果在你的开发中需要借助于日志进行调试和审计，你也许需要log4cxx。

如果想学习 Log4cxx 日志框架的使用和配置，可以按照以下步骤进行学习：

1. 官方文档：Log4cxx 官方网站提供了详细的文档，包括用户手册、开发指南和示例代码。您可以查阅官方文档来了解 Log4cxx 的基本概念、API 接口和配置方式。官方文档通常提供了全面而系统的学习资料，是学习 Log4cxx 最重要的参考之一。
2. 示例代码：Log4cxx 提供了示例代码，可以帮助您快速入门和理解框架的使用。您可以通过运行示例代码，观察其输出结果，并对比代码中的配置信息，了解不同配置选项的效果。
3. 教程和博客文章：在互联网上可以找到一些教程和博客文章，介绍了 Log4cxx 的基本概念、用法和配置技巧。这些教程和文章通常由开发者或经验丰富的用户编写，可以提供一些实用的技巧和建议。
4. 实践和调试：学习 Log4cxx 最好的方式是通过实际项目或实验来应用和调试它。您可以在自己的项目中引入 Log4cxx，并根据需求进行配置和调试。通过实际应用，您可以更深入地理解框架的工作原理和使用方法，并发现并解决潜在的问题。
5. 社区和论坛：Log4cxx 有一个活跃的社区和论坛，您可以加入其中，与其他用户交流和讨论。在社区中，您可以提出问题、分享经验，获取更多关于 Log4cxx 的实用技巧和最佳实践。

总的来说，学习 Log4cxx 需要结合官方文档、示例代码、教程和实践，通过不断实践和调试来熟悉和掌握框架的使用。

通过理论学习和实际应用相结合，您可以逐步提升对 Log4cxx 的理解和技能，从而灵活、高效地使用和配置 Log4cxx 日志框架。

### 介绍

官方站点：https://logging.apache.org/

Apache log4cxx是一个以Apache log4j为模式的开源的C++的日志记录框架。几乎每个大型应用程序都包含自己的日志记录或跟踪 API。在代码中插入 log 语句是一种技术含量低的调试方法，也可能是唯一的方法，因为调试器并不总是可用或适用。多线程应用程序和整个分布式应用程序通常都是这种情况。

 经验表明，日志记录是开发周期的重要组成部分。它提供了几个优点。它提供了有关应用程序运行的精确上下文，一旦插入到代码中，日志记录输出的生成就不需要人为干预。此外，日志输出可以保存在持久性介质中，以便以后研究。除了在开发周期中的使用之外，足够丰富的日志记录包也可以被视为审计工具。

日志记录确实有其缺点。它可能会减慢应用程序的速度。如果太冗长，可能会导致滚动失明。为了缓解这些问题，Log4cxx被设计为可靠，快速和可扩展。由于日志记录很少是应用程的主要焦点，因此Log4cxx API力求易于理解和使用。

### 构建

要让log4cxx为你工作，通常情况下需要如下几个步骤：

1. 获取软件包：得到log4xx的源代码；下载完成后解压缩到合适的目录中，因为我们在下一步中需要使用软件包，包括编译和复制必要的文件。

2. 编译：构建库文件；

    打开原始发行包中的代码。打开你的Visual Studio IDE，并加载以下目录中的工程

    如果使用了其他的编译器或者IDE工具，需要通过CMakelist.txt获取文件依赖关系，通过目标编译工具编译依赖库，在第4章高级教程中介绍该部分

    - Msvc\static：该工程产生log4cxx的静态链接库(lib4cxx.lib和lib4cxxs.lib)
    - Msvc\dll：该工程产生log4cxx的动态链接库(lib4cxx.dll)
    - 通常情况下，工程都可以顺利编译通过。查看输出目录，把这些生成的库文件找出来，以便在下一步骤中使用。

3. 项目环境设置：加入log4cxx支持。

    对于c++开发者，引用外部链接文件，通常需要完成两个部分：头文件与链接库。链接库分为动态链接和静态链接。

    - 首先需要设置log4cxx的include文件。这些文件位于log4cxx软件包的include\log4cxx目录内。请查看你的VC++ IDE中“工具->选项->项目->VC++目录->包含文件”所列出的内容，以便确定你以何种方式加入这些include文件.
    - 下一步需要对产生的log4cxx库进行设置。这取决于你使用该库的方式：静态链接或者动态链接。(了解静态库与动态库区别)
    -  静态链接情况下：为预编译器定义LOG4CXX_STATIC宏，设置位置为“项目->属性->配置属性->C/C++->预处理器->预处理器定义”；为链接器指定依赖的库lib4cxxs.lib和Ws2_32.lib，设置位置为“项目->属性->配置属性->链接器->输入->附加依赖项”
    - 动态链接情况下需要为链接器指定依赖的库lib4cxxs.lib即可，设置方式同上。
    - 将include\log4cxx直接拷贝到已定义的包含文件目录中。如果将log4cxx 看作是一项系统服务的话，这样做是胡合乎情理的，因为你可以采用标准库的方式使用它，例如：#include <log4cxx/logger.h>
    - 增加一个包含路径，以指向位于IDE外部的某一文件目录。可以简单的指向在解压缩后形成的log4cxx软件包目录。



### 实例代码

一个最简单的log4cxx示例，以便你可以快速的了解，

该示例在功能上创建了一个日志服务，该日志可<font color='#BAOC2F'>通过配置文件进行必要控制</font>，并<font color='#BAOC2F'>可以同时向文件和控制台输出信息</font>。

在实现上，我们采用了一个简单的控制台程序，并使用动态链接库的方式使用log4cxx。

1. 创建一个名为logdemo的空白win32控制台工程，并对其进行设置。注意，这里我们使用动态连接的方式。

    在logdemo.cpp中加入实现日志功能的代码。完成后的代码清单如下： 以Debug方式编译工程，调试程序直到成功为止。

    ```cpp
    #include "stdafx.h"
    #include <log4cxx/logger.h>
    #include <log4cxx/propertyconfigurator.h>
    using namespace log4cxx;
    int _tmain(int argc, _TCHAR* argv[]) {
        //加载log4cxx的配置文件，这里使用了属性文件
        PropertyConfigurator::configure("log4cxx.properties");
        //获得一个Logger，这里使用了RootLogger
        LoggerPtr rootLogger = Logger::getRootLogger();
    
        //发出INFO级别的输出请求
        LOG4CXX_INFO(rootLogger, _T("它的确工作了"));
        //rootLogger->info(_T("它的确工作了")); //与上面那句话功能相当
        return 0;
    }
    ```

2. 新建一个文本文件，命名为log4cxx.properties，并键入如下内容：设置root logger为DEBUG级别，使用了ca和fa两个Appender

    ```
    log4j.rootLogger=DEBUG, ca, fa
    ```

    复制log4cxx.dll到应用程序输出目录。在动态链接方式下，应用程序需要能够找到这个库文件。

3. 运行生成的logdemo.exe文件，查看一下运行结果，看看我们工作有没有取得成效。如果一切顺利，无论是在控制台还是在输出文件中，都应该能看到类似下面那样的输出内容：2022-09-20 16:09:50,609 [2528] INFO root - 它的确工作了



### 高级教程

#### 核心类

Log4cxx有三个关键组件，它们是loggers, appenders和layouts。

Logger是log4cxx的核心类，只要执行日志操作；looger有层次结构，最顶层为RootLogger;

logger是有级别的，每个logger可以附加多个Appender，Appender代表了日志输出的目标，如输出到文件、控制台等等。对于每一种appender，都可以通过layout进行格式设置。



#### 配置类

此外在使用中还会用到的类有BasicConfigurator、PropertyConfigurator和DOMConfigurator等，用于对log4cxx进行配置。其中：

BasicConfigurator提供了一种简单配置，包括使用ConsoleAppder作为root appender和PatternLayout作为缺省布局，

- PropertyConfigurator使用properties文件作为配置方式。
- DOMConfigurator则使用properties文件作为配置方式。



#### 使用mingw进行库文件编译

需要两个过程进行编译

CMake

Make

Eclipse中加入log4cxx支持



### 实践

在项目中是否使用日志，以及如何使用日志，对开发者来说都是一个需要做出的技术选择，这通常会牵扯到系统的性能，使用日志的目的等问题。

我们使用日志的方式，有些是这个行业积累了多年的经验，有些则纯粹关乎个人的喜好。

#### 何时使用日志

1. 通常情况下，日志的作用在于调试和审计，如果你的项目对此有特殊需求，即可考虑使用日志。对于调试，通常用于IDE调试器无法达到的地方。一些常见的场景包括：
2. 多线程的调试。使用单步调试方法是不适用的情况下，选择日志输出调试信息是一个好的选择。使用异步日志可以将日志输出的性能损失降低。这样不会阻塞调试的动态性。
3. 对于审计应用，则需要视特定的情况而定，程序级的记录能力，无疑可以作为业务级审计手段的有效补充。
4. 生产环境下的调试。生产环境通常是指产品在客户处处于正式运行的状态，在出现问题时，开发者常常不在现场，借助日志的输出进行错误判断就是一个非常有效的手段。
5. 链接库调试。在无法跟踪进外部库中的情况下，这种方法非常有效。
6. 分布式组件的调试。在服务器端的组件，需要通过客户端的调用来验证其工作是否正确，此时利用日志的输出作为辅助工具对错误进行诊断。
7. 无论是在哪种场景下，log4cxx都是可以胜任工作的，这取决于它的灵活的配置能力及多种类型的输出方式。

#### 性能问题

1. 关闭日志，通过配置文件设置日志的关闭和打开
2. 使用宏代替logger的输出命令。
3. 选择性输出日志。建立logger的层次结构，根据级别选择性输出。
4. 输出目标。尽可能减少输出目标。选择合适的输出目标。
5. 选择合适的输出格式。使用SimpleLayout将达到与std::cout相当的速度。



#### 何时使用异步日志

Log4cxx支持异步日志输出，它使用有界缓冲区来存储日志记录事件。

异步应用程序将收集发送给它的事件，然后将它们分派给附加到它的所有输出项。

异步应用程序使用单独的线程为其边界缓冲区中的事件提供服务。异步日志可以提高程序响应能力，这对时间紧迫型场景有帮助。在时间紧迫型场景下使用异步日志，通常需要配置日志输出线程的优先级别以降低日志输出线程对CPU的占用。

有些期望提高系统的响应性的场景，可使用异步日志。如本文开始所述，增加日志会减慢应用程序的速度。异步日志可以缓解这一状况。

#### 回到同步日志

异步日志不是实时响应的。例如：在调试阶段日志程序的崩溃，缓冲区日志并没有输出到响应的输出项，这会令调试者感到迷惑，无法准确的定位程序的异常。如果确实需要应用同步日志方法，请将日志方法修改到同步日志。



#### 使用滚动日志

滚动日志提供了丰富的配置项，可以根据需要选用。

#### 其它

使用类的全限定名对logger命名，在官网可以找到更多内容。

























