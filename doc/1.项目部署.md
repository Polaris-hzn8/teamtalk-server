# 项目部署

---

文档地址：https://www.yuque.com/linuxer/xngi03/ol8e7u

# 1.项目编译打包

### 第三方依赖

teamtalk-server引用了很多第三方库，包括mysql、hiredis、nginx、protobuf、log4cxx等等，

服务端对pb、hiredis、mysql_client、log4cxx有依赖所以需要先安装这些依赖，可以自行安装或者执行auto目录下的自动安装脚本，

这些脚本执行完后会自动将头文件和库文件拷贝至指定的目录

#### hiredis

make_hiredis.sh

#### mysql_dev

make_mariadb.sh

#### log4cxx

make_log4cxx.sh

#### protobuf

make_protobuf.sh

所有的通讯协议文件都在pb目录下，其中涉及两个自动化脚本：

1. create.sh：使用protoc将协议文件转化成对应语言的源码

2. sync.sh：将生成的源码移动到目标目录下 `/server/src/base/pb/protocol` 


### 服务器编译打包

在所有的依赖以及Pb文件都编译通过后，执行脚本进行整个服务端项目的编译：

编译整个项目工程：`sudo ./build_ubuntu.sh version 1.0`，在上级目录中生成 im-server-1.0.tar.gz 压缩软件包。

# 2.部署环境搭建

### mysql

1. 安装mysql服务器端与客户端

   ```shell
   sudo apt-get -y install mysql-server
   sudo apt-get -y install mysql-client
   ```

2. 安装mysql开发工具包

   ```shell
   sudo apt-get -y install libmysqlclient-dev
   ```

3. 验证是否安装成功

   ```shell
   sudo netstat -tap | grep mysql
   sudo lsof -i:3306 #查看数据库默认端口3306
   ```

   ![image-20250214234837273](assets/image-20250214234837273.png)

4. 设置mysql账号密码：

   ```shell
   # 查看默认密码
   sudo cat /etc/mysql/debian.cnf
   # # ubuntu18.04则以无密码的方式登录
   mysql -u root -p !@#123qwe
   mysql>use mysql;
   #  更新 plugin 及 authentication_string 字段，比如密码123456
   mysql> UPDATE user SET plugin="mysql_native_password", authentication_string=PASSWORD("!@#123qwe") WHERE user="root";
   #　输出以下结果
   Query OK, 1 row affected, 1 warning (0.00 sec)
   Rows matched: 1  Changed: 1  Warnings: １
   # 保存更新结果
   mysql> FLUSH PRIVILEGES;
   # 退出并重启 mysql
   mysql> exit;
   sudo service mysql restart
   ```

5. 启动/停止/重启mysql服务

   ```shell
   service mysql start 	//启动mysql
   service mysql restart 	//重新启动mysql
   service mysql stop 		//关闭mysql
   ```

### redis/hiredis

以源码的方式进行安装，hiredis的安装在dbproxy工程中会被使用到，

1. 下载redis源码到合适的位置

   ```shell
   wget http://download.redis.io/releases/redis-6.2.5.tar.gz
   ```

2. 解压缩包并编译安装

   ```shell
   # 解压压缩包
   tar -zxvf redis-6.2.5.tar.gz
   # 编译源码
   cd redis-6.2.5
   make
   # 编译安装依赖文件
   cd deps
   make hiredis  linenoise lua jemalloc
   cd hiredis
   sudo make install
   cd ../lua
   sudo make install
   # 安装redis
   cd ../../src
   sudo make install
   ```

3. 启动Redis后台运行

   启动Redis后台运行，修改配置文件 redis.conf（在redis源码目录下）

   注意先不要设置redis授权信息auth，导致服务连不上redis

   ```shell
   # 修改配置文件
   修改 stop-writes-on-bgsave-error 设置为 no
   修改 daemonize 设置为 yes
   # 运行redis后台服务
   /home/ubuntu/softs/redis-6.2.5/src/redis-server /home/ubuntu/softs/redis-6.2.5/redis.conf
   ```

4. 验证是否安装成功

   ```shell
   sudo netstat -tap | grep redis
   sudo lsof -i:6379	# 查看6379端口监听情况
   ```

   ![image-20250215010127249](assets/image-20250215010127249.png)

### nginx

1. 编译安装Nginx源码：

   ```shell
   # 安装必要的第三方依赖包
   sudo apt-get -y install libpcre3 libpcre3-dev
   sudo apt-get -y install zlib1g-dev
   sudo apt-get install openssl libssl-dev
   # 下载稳定的Nginx版本
   wget http://nginx.org/download/nginx-1.16.1.tar.gz
   # 解压编译安装
   # 安装后的执行文件路径：/usr/local/nginx/sbin/
   # 配置文件路径：/usr/local/nginx/conf/
   tar -zxvf nginx-1.16.1.tar.gz
   cd nginx-1.16.1
   ./configure --prefix=/usr/local/nginx
   make
   sudo make install
   # 创建配置文件子目录 并在nginx.conf文件中包含conf.d
   # 在末尾添加 include /usr/local/nginx/conf/conf.d/*.conf;
   # 目的是在部署即时通讯的web管理后台时将对应的.conf文件拷贝到 /usr/local/nginx/conf/conf.d 目录时就能够被 nginx.conf 包含
   sudo mkdir /usr/local/nginx/conf/conf.d
   sudo mkdir -p /usr/local/nginx/conf/conf.d/
   sudo vim /usr/local/nginx/conf/nginx.conf
   # 将默认的80端口修改为81 因为web管理后台需要占用80端口
   server {
   	listen 81;
   	server_name localhost;
   	wcharset koi8-r;
   }
   ```

2. 配置启动Nginx

   ```shell
   # 创建一个nginx.service
   # 在 /lib/systemd/system/目录下面新建一个nginx.service文件，并赋予可执行的权限
   sudo vim /lib/systemd/system/nginx.service
   # 编辑service内容
   [Unit]
   Description=nginx - high performance web server
   After=network.target remote-fs.target nss-lookup.target
   [Install]
   WantedBy=multi-user.target
   [Service]
   Type=forking
   ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
   ExecReload=/usr/local/nginx/sbin/nginx -s reload
   ExecStop=/usr/local/nginx/sbin/nginx -s stop
   # 启动服务
   # 在启动服务之前，需要先重载systemctl命令
   sudo systemctl daemon-reload
   sudo systemctl start nginx.service # 启动nginx
   ```

3. 启动/停止/重启Nginx服务

   ```shell
   sudo systemctl start nginx.service	# 启动
   sudo systemctl stop nginx.service	# 停止
   sudo systemctl reload nginx.service 	# 重新加载
   systemctl status nginx.service			# 显示nginx服务的状态
   sudo systemctl enable nginx.service		# 在开机时启用nginx服务
   sudo systemctl disable nginx.service	# 在开机时禁用nginx服务
   ```

4. 查看Nginx运行情况：

   ```shell
   sudo ps -ef | grep nginx
   sudo netstat -tap | grep nginx
   sudo lsof -i:81	# 查看81端口监听情况
   ```

   ![image-20250215013158233](assets/image-20250215013158233.png)



# 3.项目部署运行

### 数据库导入

```shell
sudo ./ttopen.sh install
```

### 防火墙端口开放

| 服务            | 服务说明                                                     | 开放端口   |
| --------------- | ------------------------------------------------------------ | ---------- |
| msg_server      | 消息服务器：用户登录成功后 与指定的消息服务器进行交互        | 8000       |
| login_server    | 登录服务器：负责身份验证、并为登录成功的客户端分配 msg_server，<br/>该服务监听两个端口，tcp端口8100（与后端的服务器交互）、http端口8080（对外开放） | 8100、8080 |
| route_server    | 消息转发服务器：位于不同的消息服务器上的用户之间，交互需要通过此服务器进行消息转发 | 8200       |
| http_msg_server | 主要提供对外的Web-API服务                                    | 8400       |
| push_sever      | 消息推送服务器：针对移动端进行主动的消息推送                 | 8500       |
| file_server     | 文件中转服务器：做文件中转与临时存储                         | 8601       |
| msfs            | 文件存储服务器：小文件永久存储，包括聊天产生的图片、表情等   | 8700       |
| db_proxy_server | 数据库代理服务器：后端为存储层、代理mysql和redis对数据进行读写操作 | 10600      |
| mysql           | mysql                                                        | 3306       |
| nginx           | nginx                                                        | 81         |
| web             | teamtalk-web                                                 | 80         |

### 部署IM服务后台

1. 解压im-server-1.0.gz软件安装包：`tar -xf im-server-1.0.tar.gz` 
2. 根据需要修改conf目录下的配置文件
3. 执行脚本进行服务器端程序的部署与启动 `sudo ./setup.sh install` 















